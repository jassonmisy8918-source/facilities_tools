---
description: 排水设施管理平台 "6+1" 系统完整开发流程 (根据 demand.md 需求生成)
---

# 排水设施管理平台开发流程

> 本流程基于 `demand.md` 需求文档，覆盖 **"6+1" 系统**的完整开发生命周期。
> "6" = 排水设施资产管理、综合监测、巡查养护、泵站智能运维、污水处理提质增效、运行驾驶舱
> "1" = 智慧排水APP（移动端）

---

## 阶段一：项目初始化与技术选型

### 1.1 项目结构初始化

1. 创建 monorepo 项目根目录结构：
```
Drainage-facilities/
├── apps/
│   ├── web/                  # PC端（B/S架构主系统）
│   ├── cockpit/              # 运行驾驶舱（大屏端）
│   └── mobile/               # 智慧排水APP（iOS/Android）
├── packages/
│   ├── shared/               # 共享类型、工具函数、常量
│   ├── ui/                   # 共享UI组件库
│   ├── gis-core/             # GIS核心引擎封装
│   ├── api-client/           # API客户端SDK
│   └── data-models/          # 数据模型定义
├── services/
│   ├── gateway/              # API网关
│   ├── asset-service/        # 排水设施资产管理服务
│   ├── monitoring-service/   # 综合监测服务
│   ├── patrol-service/       # 巡查养护服务
│   ├── pump-station-service/ # 泵站智能运维服务
│   ├── quality-service/      # 污水处理提质增效服务
│   ├── cockpit-service/      # 运行驾驶舱数据聚合服务
│   ├── alarm-service/        # 统一报警服务
│   ├── workflow-service/     # 工单流程引擎
│   └── file-service/         # 文件存储服务
├── infra/
│   ├── docker/               # Docker配置
│   ├── k8s/                  # Kubernetes编排
│   └── database/             # 数据库迁移脚本
├── docs/                     # 项目文档
├── demand.md                 # 需求文档
└── README.md
```

2. 初始化包管理与构建工具（如 pnpm workspace / Turborepo）
3. 配置 ESLint、Prettier、Husky、commitlint 代码规范
4. 配置 CI/CD 流水线（GitHub Actions / Jenkins）

### 1.2 技术栈确定

| 层级 | 技术选型 | 说明 |
|------|----------|------|
| **前端框架** | Vue 3 + TypeScript | PC端、驾驶舱 |
| **移动端** | uni-app / React Native | iOS + Android 双端 |
| **GIS引擎** | OpenLayers / Cesium | 2D地图 + 3D视图 |
| **图表** | ECharts / AntV | 统计图表、大屏可视化 |
| **后端框架** | NestJS / Spring Boot | 微服务架构 |
| **数据库** | PostgreSQL + PostGIS | 空间数据存储 |
| **时序数据** | TimescaleDB / InfluxDB | 监测数据存储 |
| **消息队列** | RabbitMQ / Kafka | 实时预警、异步处理 |
| **缓存** | Redis | 会话、热点数据、实时状态 |
| **对象存储** | MinIO / OSS | 图片、视频、文件 |
| **容器化** | Docker + Kubernetes | 云原生部署 |

### 1.3 数据库设计

1. 设计 PostGIS 空间数据库 schema：
   - 排水管网空间表（管道、检查井、雨水口等）
   - 设施台账表（泵站、污水厂、闸门、阀门等）
   - 监测设备表与监测数据时序表
   - 工单流程表（巡查工单、养护工单、维修工单）
   - 报警规则表与报警事件表
   - 排水分区表（污水分区、雨水分区、行政分区）
   - 用户权限表
2. 定义空间索引策略
3. 编写数据库迁移脚本
4. 准备测试数据种子

---

## 阶段二：基础设施与公共模块开发

### 2.1 GIS核心引擎（`packages/gis-core`）

> 对应需求：9.1.1.4.1 设施一张图

1. 封装地图基础操作：
   - 放大/缩小/漫游/全局视图
   - 三维视图切换（集成Cesium）
   - 动态比例尺
   - 多视窗对比
   - 地图书签管理
   - 地图截图导出
2. 图层管理引擎：
   - 卫星影像/矢量/实景三维 数据加载
   - 图层叠加、透明度调整
   - 动态热力图生成
   - 图层样式模板
   - 图层分组可见性控制
   - 图层元数据与数据量统计
3. 空间分析工具集：
   - 距离/面积测量
   - 文本/箭头标注
   - 缓冲分析
   - 坐标/地名/兴趣点定位
   - 空间关系查询
   - 地理编码批量查询

### 2.2 统一报警服务（`services/alarm-service`）

> 对应需求：多个系统的预警管理模块

1. 报警规则引擎：规则 CRUD、启用停用、分类管理
2. 实时报警处理：阈值检测、事件汇聚、去重
3. 报警通知推送：短信/APP/邮件多通道
4. 报警处置闭环：事件单 → 派发 → 处置 → 验收
5. 历史报警查询与统计

### 2.3 工单流程引擎（`services/workflow-service`）

> 对应需求：巡查工单、养护工单、维修工单、报修工单

1. 通用工单模型：创建、审核、派发、跟踪、验收
2. 工单模板管理
3. 审批流程配置（多级审批）
4. 工单状态机
5. 工单统计报告生成

### 2.4 统一认证与权限

1. 用户认证（JWT / OAuth2）
2. 角色权限管理（RBAC）
3. 数据范围权限（按区域、按分区）

---

## 阶段三：核心子系统开发（按优先级排序）

### ► 第一优先级：排水设施资产管理系统（9.1.1）

> 基础数据系统，其他系统依赖此系统的设施数据

**后端 `services/asset-service`：**

1. **设施台账 CRUD**（需求 9.1.1.4.1.4）
   - 排水户、管网、检查井、雨水口
   - 泵站、污水处理厂、闸门
   - 截留设施、溢流堰、阀门
   - 排放口、监测设备
2. **数据质检引擎**（需求 9.1.1.4.2.1）
   - 管道混错接检测
   - 大管接小管逻辑检查
   - 断头点识别、逆坡分析
   - 孤立设施检查、重复要素检测
   - 批量质检、规则模板库
   - 质检报告生成导出
3. **数据修复**（需求 9.1.1.4.2.2）
   - 图形冲突调整、断连管线修复
   - 拓扑一致性修正
   - 修复过程记录与回滚
   - 数据版本回溯
4. **数据接边处理**（需求 9.1.1.4.2.3）
5. **普查成果管理**（需求 9.1.1.4.2.4）
6. **在线编辑**（需求 9.1.1.4.2.5）
   - 节点/管线/区域绘制
   - 属性编辑、批量操作
   - 撤销/重做、编辑冲突检测

**前端 `apps/web` — 资产管理模块：**

1. **设施一张图页面**
   - 专题图层（9个专题：排水设施、监测设备、缺陷、错混接、外水入侵、排放口、巡查养护、预警、规划）
   - 图层管理面板
   - 设施台账信息面板
   - 定位查询工具栏
   - 图表统计面板
   - 测量标注工具栏
2. **数据资源管理页面**
   - 质检任务管理
   - 数据修复工作台
   - 普查成果管理
   - 在线编辑器（集成GIS编辑控件）
3. **网络/空间分析**（需求 9.1.1.4.3）
   - 连通性分析、故障点定位
   - 上下游影响范围分析、流向动画
   - 坡度分析与分级渲染
   - 横/纵断面分析
   - 管线碰撞分析与风险评估
   - 淹没分析与经济损失估算
   - 环状管网诊断、管段服务面积
4. **排水分区管理**（需求 9.1.1.4.4）
   - 污水/雨水/行政/网格分区管理
   - 多分区指标对比
   - 分区关联设施统计

---

### ► 第二优先级：综合监测系统（9.1.2）

> 依赖资产系统的设施和设备数据

**后端 `services/monitoring-service`：**

1. **数据采集接入**
   - 雨量计、流量计、液位计、水质计 数据接入
   - 气象信息集成（天气预报、雷达、卫星云图、台风）
   - 视频监控接入
2. **监测点位管理**（需求 9.1.2.4.4.5）
   - 点位信息 CRUD、指标数据项配置
   - 关联监测因子、关联监测设备
3. **监测设备管理**（需求 9.1.2.4.4.6）
   - 设备台账、批量修改
   - 四类仪器（雨量计/流量计/液位计/水质计）运行信息管理
   - 故障信息、触发预警、维护信息管理
4. **监测因子与指标管理**（需求 9.1.2.4.4.7-8）
5. **监测数据分析引擎**（需求 9.1.2.4.3）
   - 实时/历史数据查询（雨量/流量/水位/水质）
   - 多点位对比、同比/环比分析
   - 极值统计、趋势分析、相关性分析
   - 异常数据智能识别
   - 报表管理（日处理量、BOD分析等）
6. **智能预警管理**（需求 9.1.2.4.4）
   - 调用统一报警服务
   - 报警研判、报警处置

**前端 `apps/web` — 监测模块：**

1. 气象信息展示页（天气、雷达、云图、台风）
2. 实时监测大屏（降雨/流量/水位/水质 实时面板）
3. 监测数据分析工作台
4. 智能预警管理中心

---

### ► 第三优先级：巡查养护系统（9.1.3）

**后端 `services/patrol-service`：**

1. **巡查计划管理**（需求 9.1.3.4.1.1）
   - 计划 CRUD、频率/路线/检查点设置
   - 人员排班、优先级设定
   - 计划审批流程、计划模板
2. **巡查工单管理**（需求 9.1.3.4.1.2）
   - 调用统一工单引擎
   - 实时位置监控、进度可视化
3. **问题上报**（需求 9.1.3.4.1.3）
4. **应急事件管理**（需求 9.1.3.4.1.5）
   - 预案管理、模拟演练
   - 应急资源调度优化
   - 事件记录与报告生成
5. **养护计划管理**（需求 9.1.3.4.2.1）
   - 计划调整优化、材料库存管理
   - 养护审批、历史记录查询
6. **养护工单管理**（需求 9.1.3.4.2.2）
   - 任务自动分配、工时记录
   - 养护成本统计、设备状态监控
7. **仪表维护**（需求 9.1.3.4.2.4）
   - 校准记录、超期告警、故障诊断
8. **设备管理**（需求 9.1.3.4.2.5）
   - 车辆/检测仪器台账
   - 二维码标签生成/扫描
   - 保养/维修/报废管理
   - 设备故障预测
9. **统计分析**（需求 9.1.3.4.3）
   - 巡查工作统计（任务完成率、工作时长、里程等）
   - 养护工作量统计（成本、效率）
   - 绩效评估（指标管理、报告生成）

**前端 `apps/web` — 巡查养护模块：**

1. 巡查计划管理页
2. 巡查工单管理页 + 地图工作台
3. 养护计划管理页
4. 养护工单管理页 + 地图工作台
5. 仪表维护管理页
6. 设备管理页
7. 统计分析看板

---

### ► 第四优先级：泵站智能运维系统（9.1.4）

**后端 `services/pump-station-service`：**

1. **远程监控**（需求 9.1.4.4.1）
   - 实时数据采集（前/后池水位、进/出水流量）
   - 视频监控接入
   - 异常流量分析与预警
   - 泵站分类展示、运行数据汇总
2. **设备管理**（需求 9.1.4.4.2）
   - 设备台账（含报废、变动、调拨跟踪）
   - 设备巡检（计划 → 任务 → 结果 → 闭环）
   - 设备保养（模板、计划、记录）
   - 设备综合管理（KPI、备品备件）
3. **报警管理**（需求 9.1.4.4.3）
   - 报警规则配置、事件管理
   - 通知推送、处置闭环
4. **运维管理**（需求 9.1.4.4.4）
   - 设备预测性维护
   - 报修 → 审核 → 派发 → 工单处理 → 验收 → 维修记录
   - 多方会商、历史案例知识库
5. **能耗管理**（需求 9.1.4.4.5）
   - 能耗实时监测（总电耗、单泵电耗、占比）
   - 历史能耗分析（趋势、节能潜力、行业标杆）
   - 碳排放量管理与计算
6. **报表与决策**（需求 9.1.4.4.6）
   - 运行日报/月报
   - 故障分析（类型、频率、修复时间、热点图）
   - 能耗预测模型
   - 运维绩效评估（工单完成率、响应时效、设备健康指数）
   - 瓶颈诊断与改造建议
   - 应急预案推演（数字孪生）

**前端 `apps/web` — 泵站运维模块：**

1. 泵站远程监控大屏
2. 设备管理中心
3. 报警管理中心
4. 运维工单工作台
5. 能耗监测分析看板
6. 报表与决策支持页

---

### ► 第五优先级：污水处理提质增效系统（9.1.5）

**后端 `services/quality-service`：**

1. **管道健康管理**（需求 9.1.5.4.1）
   - 缺陷检测（AI图像识别）、管道标记
   - 结构性/功能性缺陷识别
   - 管网健康度评价（多因素综合评估）
   - 养护指数体系
   - 修复管理（优先级排序、方案推荐、进度跟踪、成本管理）
   - 效果跟踪（复查、改善分析、报告）
2. **外水入侵分析**（需求 9.1.5.4.2）
   - 入侵检测、异常波动识别
   - 来源分析、入侵点定位
   - 应对措施（方案建议、工单关联、执行跟踪）
3. **雨污混接分析**（需求 9.1.5.4.3）
   - 混接识别（水流/水质分析、算法配置）
   - 影响评估（水质/水量/处理厂/水环境）
   - 优化建议（改造方案、效果模拟）
4. **污水调度**（需求 9.1.5.4.4）
   - 策略制定（历史分析、负荷评估、模拟测试）
   - 实时调度（水位/流量分析、远程调节）
   - 调度数据分析（模型优化、评估报告）
5. **排水户管理**（需求 9.1.5.4.5）
   - 排水户信息管理（分级分类、导入导出）
   - 接驳管网联动管理
   - 水质水量监测分析
6. **按效付费管理**（需求 9.1.5.4.6）
   - 绩效指标体系管理
   - 绩效评估与动态考核
   - 付费报告管理

**前端 `apps/web` — 提质增效模块：**

1. 管道健康管理中心
2. 外水入侵分析工作台
3. 雨污混接分析工作台
4. 污水调度管理页
5. 排水户管理页
6. 按效付费管理页

---

### ► 第六优先级：运行驾驶舱（9.1.6）

> 数据聚合展示层，依赖前五个子系统的数据

**后端 `services/cockpit-service`：**

1. 数据聚合接口（从各子系统汇聚核心指标）
2. 统计分析接口
3. 预警信息汇聚接口

**前端 `apps/cockpit`：**

1. **专题图层**（需求 9.1.6.4.1，13个专题一张图）
   - 排水设施、监测设备、缺陷、错混接、外水入侵
   - 排放口、巡查养护、警告预警、排水规划
   - 排水户、高水位管段、地面塌陷风险、施工工地临时排水
2. **情况介绍**（区域信息、管理主体）
3. **排水设施信息**（全要素逻辑图、防涝设施统计、污供比分析）
4. **降雨预报**
5. **监测设备/对象统计**
6. **缺陷信息统计**
7. **巡查养护信息**（工单统计、人员绩效）
8. **泵站运维信息**（工单统计、设备健康、能效分析）
9. **提质增效信息**（进/出水浓度、缺陷/入侵/混接统计）
10. **信息报警**（多类型预警展示与统计）

---

### ► 第七优先级：智慧排水APP（9.1.7）

**前端 `apps/mobile`：**

1. **排水设施资产管理**（需求 9.1.7.4.1）
   - 设施一张图（移动端适配）
   - 网络/空间分析
   - 设施信息查看、二维码扫描、照片上传
   - 离线地图数据包
2. **综合监测**（需求 9.1.7.4.2）
   - 气象信息、实时监测数据
   - 智能预警（报警列表、导航、推送）
   - 离线数据缓存
3. **巡查养护**（需求 9.1.7.4.3）
   - 巡查任务管理（轨迹记录、打卡、问题上报、拍照水印、离线模式）
   - 养护任务管理（过程记录、完成确认、知识库、设备领用）
   - 个人统计看板
4. **泵站智能运维**（需求 9.1.7.4.4）
   - 远程监控（视频、远程控制）
   - 设备台账（二维码扫描、保养/维修记录）
   - 报警管理
   - 运维工单（接收、转派、退单、处理、验收）
   - 能耗监测
5. **工单移动端**（需求 9.1.7.4.5）
   - 工单录入（快速创建、扫码、模板）
   - 工单办理（工作台、流程推进、附件、时限预警）
   - 工单查询（全局搜索、高级筛选）
   - 工单追溯（生命周期、时间轴、照片轴）

---

## 阶段四：系统集成与联调

### 4.1 子系统间对接

1. 资产系统 ↔ 监测系统：设施台账与监测设备关联
2. 监测系统 ↔ 报警服务：监测数据触发预警
3. 巡查养护 ↔ 工单引擎：巡查/养护工单流转
4. 泵站运维 ↔ 监测系统：泵站监测数据共享
5. 提质增效 ↔ 资产系统：管道缺陷、健康度数据联动
6. 驾驶舱 ↔ 全部子系统：数据聚合展示
7. APP ↔ 后台系统：数据实时同步

### 4.2 接口联调

1. API 契约测试
2. E2E 流程测试（工单全流程、预警处置流程）
3. GIS 数据加载性能测试
4. 大屏渲染性能优化

---

## 阶段五：测试与质量保障

### 5.1 测试策略

| 测试类型 | 范围 | 工具 |
|----------|------|------|
| 单元测试 | 服务层、工具函数 | Jest / Vitest |
| 集成测试 | API 接口、数据库 | Supertest |
| E2E测试 | 关键业务流程 | Playwright / Cypress |
| 性能测试 | GIS加载、大屏渲染、API并发 | k6 / JMeter |
| 安全测试 | 认证鉴权、SQL注入、XSS | OWASP ZAP |

### 5.2 测试场景（关键路径）

1. 设施一张图全量数据加载与查询
2. 监测数据实时采集 → 阈值超标 → 触发预警 → 推送通知 → 处置闭环
3. 巡查计划 → 工单派发 → 现场执行 → 问题上报 → 处置验收
4. 泵站远程监控 → 故障报修 → 审核 → 派发 → 维修 → 验收
5. 管道缺陷识别 → 健康度评估 → 修复方案推荐 → 效果跟踪
6. 驾驶舱多维数据实时聚合与展示

---

## 阶段六：部署与上线

### 6.1 环境规划

| 环境 | 用途 | 部署方式 |
|------|------|----------|
| dev | 开发调试 | Docker Compose |
| staging | 集成测试 | K8s 集群 |
| production | 生产环境 | K8s 集群 + 高可用 |

### 6.2 上线清单

1. 数据库初始化与数据迁移
2. GIS底图数据部署（卫星影像、矢量、三维）
3. 监测设备接入联调
4. 视频监控系统对接
5. 短信/邮件通知服务配置
6. SSL证书与安全加固
7. 日志监控与告警配置（ELK / Prometheus + Grafana）
8. 备份策略配置
9. 灰度发布与回滚策略

---

## 开发里程碑

| 里程碑 | 内容 | 依赖关系 |
|--------|------|----------|
| **M1** | 项目初始化 + 技术选型 + 数据库设计 | 无 |
| **M2** | GIS引擎 + 报警服务 + 工单引擎 + 认证鉴权 | M1 |
| **M3** | 排水设施资产管理系统 | M2 |
| **M4** | 综合监测系统 | M2, M3 |
| **M5** | 巡查养护系统 | M2, M3 |
| **M6** | 泵站智能运维系统 | M2, M3, M4 |
| **M7** | 污水处理提质增效系统 | M2, M3, M4 |
| **M8** | 运行驾驶舱 | M3-M7 |
| **M9** | 智慧排水APP | M3-M7 |
| **M10** | 系统集成联调 + 测试 | M3-M9 |
| **M11** | 部署上线 | M10 |
